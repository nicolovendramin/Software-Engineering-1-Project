<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GameCD4.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cg25</a> &gt; <a href="index.source.html" class="el_package">it.polimi.ingsw.cg25.servers</a> &gt; <span class="el_source">GameCD4.java</span></div><h1>GameCD4.java</h1><pre class="source lang-java linenums">/**
 * 
 */
package it.polimi.ingsw.cg25.servers;

import java.io.FileNotFoundException;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Random;

import it.polimi.ingsw.cg25.actions.DisplayInteraction;
import it.polimi.ingsw.cg25.controller.ActionController;
import it.polimi.ingsw.cg25.controller.ServiceController;
import it.polimi.ingsw.cg25.exceptions.CannotCreateGameException;
import it.polimi.ingsw.cg25.exceptions.CannotPassException;
import it.polimi.ingsw.cg25.exceptions.ElementNotFoundException;
import it.polimi.ingsw.cg25.exceptions.NoCardsException;
import it.polimi.ingsw.cg25.gamegenerics.GameLogger;
import it.polimi.ingsw.cg25.model.Assistant;
import it.polimi.ingsw.cg25.model.BoardCD4;
import it.polimi.ingsw.cg25.model.Coin;
import it.polimi.ingsw.cg25.model.HSBColor;
import it.polimi.ingsw.cg25.model.MatchCD4;
import it.polimi.ingsw.cg25.model.NobilityRank;
import it.polimi.ingsw.cg25.model.PlayerCD4;
import it.polimi.ingsw.cg25.model.PocketCD4;
import it.polimi.ingsw.cg25.model.VictoryPoint;
import it.polimi.ingsw.cg25.model.dashboard.Emporium;
import it.polimi.ingsw.cg25.model.dashboard.topological.City;
import it.polimi.ingsw.cg25.onlinegenerics.OnlineApplication;
import it.polimi.ingsw.cg25.onlinegenerics.User;
import it.polimi.ingsw.cg25.proxies.ModelProxy;
import it.polimi.ingsw.cg25.proxies.ViewProxy;

/**
 * @author Davide
 * @author nicolo
 *
 */
public class GameCD4 implements Runnable, OnlineApplication {

	/**
	 * The match which is the applet of this game
	 */
	private MatchCD4 match;
	/**
	 * The max number of players that can be accepted in the game
	 */
	private final int maxLenght;
	/**
	 * The min number of active players needed to start the game
	 */
	private final int minLenght;
	/**
	 * The view proxy used by the 2 controllers of the game
	 */
	private final ViewProxy viewProxy;
	/**
	 * The actionController of the match
	 */
	private final ActionController actionController;
	/**
	 * The list of the users that have joined the game
	 */
	private List&lt;User&gt; users;
	/**
	 * The service controller used to dispatch and to receive services to be applied
	 * on this game
	 */
	private final ServiceController serviceController;
	/**
	 * If not null represents the moment in which the game will be considered closed
	 */
<span class="fc" id="L76">	private Date endingTimeStamp = null;</span>

	/**
	 * The constructor of the Game
	 * 
	 * @param min
	 *            is the minimum number of player needed to start the game
	 * @param max
	 *            is the maximum number of players that can join the game
	 * @param actionTimeOut
	 *            is the maximum time the user has to reply to an Action Query
	 * @throws FileNotFoundException
	 * @throws CannotCreateGameException
	 */
<span class="fc" id="L90">	public GameCD4(int min, int max, int actionTimeOut,BoardCD4 board,boolean hasMarket,int numberOfEmporiumsToWin) throws FileNotFoundException, CannotCreateGameException {</span>
<span class="fc" id="L91">		this.users = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L92">		this.maxLenght = max;</span>
<span class="fc" id="L93">		this.minLenght = min;</span>
<span class="fc" id="L94">		this.serviceController = new ServiceController(this);</span>
<span class="fc" id="L95">		this.actionController = new ActionController(actionTimeOut);</span>
<span class="fc" id="L96">		this.viewProxy = new ViewProxy(this.actionController, this.serviceController);</span>
<span class="fc" id="L97">		this.actionController.setViewProxy(this.viewProxy);</span>
<span class="fc" id="L98">		this.serviceController.setProxy(viewProxy);</span>
<span class="fc" id="L99">		ModelProxy temp = new ModelProxy();</span>
<span class="fc" id="L100">		temp.attachObserver(actionController);</span>
<span class="fc" id="L101">		actionController.attachObserver(temp);</span>
<span class="fc" id="L102">		GameLogger logger = new GameLogger(&quot;MatchLog&quot;, GameLogger.DEFAULT_LOG_PATH);</span>
<span class="fc" id="L103">		this.match = new MatchCD4(board, temp, hasMarket,numberOfEmporiumsToWin,logger);</span>
<span class="fc" id="L104">	}</span>

	/**
	 * Disconnects the indicated user from the game, Put it as inactive also in
	 * the players' list of the match and, if it was the current player it makes
	 * the turns go ahead
	 */
	@Override
	public synchronized void disconnect(int id, String report) {
		// We should log the report maybe?
<span class="nc bnc" id="L114" title="All 2 branches missed.">		for (User u : users)</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">			if (u.getUserID() == id) {</span>
<span class="nc" id="L116">				u.setStatus(false);</span>
			}

<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (match.isRunning()) {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">			for (PlayerCD4 p : match.getPlayers())</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">				if (p.getUserID() == id) {</span>
<span class="nc" id="L122">					p.setStatus(false);</span>
					
<span class="nc bnc" id="L124" title="All 4 branches missed.">					if(match.hasMarket() &amp;&amp; match.getMarket().isOpen()){</span>
						// Here we are during the market
<span class="nc bnc" id="L126" title="All 2 branches missed.">						if(p == match.getMarket().getCurrentPlayer()){</span>
							try {
<span class="nc" id="L128">								match.getMarket().endTurn();</span>
<span class="nc" id="L129">								match.getMarket().beginTurn();</span>
<span class="nc" id="L130">							} catch (CannotPassException e) {</span>
<span class="nc" id="L131">								match.getLogger().log(e, &quot;Passing because current player is inactive (during market)&quot;);</span>
							}
						}
<span class="nc" id="L134">					}else{</span>
						// Here we are during the match
<span class="nc bnc" id="L136" title="All 2 branches missed.">						if(p == match.getCurrentPlayer()){</span>
							// Current player becomes inactive
							try {
<span class="nc" id="L139">								match.endTurn();</span>
<span class="nc" id="L140">								match.beginTurn();</span>
<span class="nc" id="L141">							} catch (CannotPassException e) {</span>
<span class="nc" id="L142">								match.getLogger().log(e, &quot;Passing because current player is inactive&quot;);</span>
							}
						}
					}
				}
		}
<span class="nc" id="L148">		notifyAll();</span>
<span class="nc" id="L149">	}</span>

	@Override
	public void chat(String message) {
		//in our specific application the chat doesn't record the messages on the server
<span class="nc" id="L154">	}</span>

	/**
	 * This function gives back the Id of the view associated with the specified
	 * userName or throws IllegalArgumentException if not found
	 */
	@Override
	public int nameService(String name) {
<span class="nc bnc" id="L162" title="All 2 branches missed.">		for (User p : this.users) {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">			if (p.getName().equals(name))</span>
<span class="nc" id="L164">				return p.getUserID();</span>
		}
<span class="nc" id="L166">		throw new IllegalArgumentException(&quot;I cannot associate this name with an user of this game&quot;);</span>
	}

	/**
	 * This method returns the username associated with the given id or throws
	 * IllegalArgumentException if the id is not known
	 */
	@Override
	public String addressBook(int id) {
<span class="nc bnc" id="L175" title="All 2 branches missed.">		for (User p : this.users)</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">			if (p.getUserID() == id)</span>
<span class="nc" id="L177">				return p.getName();</span>
<span class="nc" id="L178">		throw new IllegalArgumentException(&quot;I don't know the name of the user you are referring to sorry&quot;);</span>
	}

	/**
	 * This method allows to a user identified by a certain id to change its
	 * username in case the match has not started yet the name will be changed
	 * in the players' list too, otherwise it will also be changed at
	 * OnlineApplicationLevel
	 */
	@Override
	public synchronized void changeUsername(int id, String newName) {
<span class="nc" id="L189">		String name = newName.replaceAll(&quot; &quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L190" title="All 4 branches missed.">		if (name == null || name.length() == 0)</span>
<span class="nc" id="L191">			throw new IllegalArgumentException(&quot;You must specify a name&quot;);</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">		for (User p : this.users)</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">			if (p.getName().equals(name)) {</span>
<span class="nc" id="L194">				notifyAll();</span>
<span class="nc" id="L195">				throw new IllegalArgumentException(&quot;The username is already used by another player of your same match&quot;);</span>
			}
<span class="nc bnc" id="L197" title="All 2 branches missed.">		for (User p : this.users)</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">			if (p.getUserID() == id) {</span>
<span class="nc" id="L199">				p.rename(name);</span>
<span class="nc" id="L200">				notifyAll();</span>
<span class="nc" id="L201">				return;</span>
			}
<span class="nc" id="L203">		notifyAll();</span>
<span class="nc" id="L204">		throw new IllegalArgumentException(&quot;I cannot recognise your identity sorry&quot;);</span>
	}

	/**
	 * A user can ask to be reconnected
	 */
	@Override
	public synchronized void connect(int id) {
<span class="nc bnc" id="L212" title="All 2 branches missed.">		for (User u : users)</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">			if (u.getUserID() == id) {</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">				if (u.isActive())</span>
<span class="nc" id="L215">					throw new IllegalArgumentException(&quot;You are already connected to the game&quot;);</span>
<span class="nc" id="L216">				u.setStatus(true);</span>
			}
<span class="nc bnc" id="L218" title="All 2 branches missed.">		if (match.isRunning()) {</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">			for (PlayerCD4 p : match.getPlayers())</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">				if (p.getUserID() == id)</span>
<span class="nc" id="L221">					p.setStatus(true);</span>
		}
<span class="nc" id="L223">		notifyAll();</span>
<span class="nc" id="L224">	}</span>

	/**
	 * Default implementation. Launches the game with 20 sec of waiting before
	 * the start
	 */
	@Override
	public void run() {
<span class="nc" id="L232">		this.run(20000);</span>
<span class="nc" id="L233">	}</span>

	/**
	 * This method closes the game and asks the view Proxy to communicate the end of the game to 
	 * all the connected users 
	 */
	public void close() {
<span class="nc" id="L240">		this.viewProxy.send(new DisplayInteraction&lt;String&gt;(&quot;quitThe game has been closed.&quot;), &quot;Quit&quot;, 0);</span>
<span class="nc" id="L241">	}</span>

	/**
	 * When the game is executed the game is instantiated following all the
	 * rules
	 * @throws InterruptedException 
	 */
	public void run(int time) {
		/*
		 * Advertises to all the players that the match is going to start and
		 * that they won't have the chance to change their player nickname after
		 * the game has been launched.
		 */
<span class="nc" id="L254">		this.viewProxy.send(</span>
<span class="nc" id="L255">				new DisplayInteraction&lt;String&gt;(&quot;Get Ready! The game is going to start in 20 seconds\n&quot;</span>
						+ &quot;Please if you want to change you Player nickname do it now\n&quot;
						+ &quot;You will still be able to change your chat username after the game have been launched&quot;),
<span class="nc" id="L258">				&quot;Info&quot;);</span>
		try {
<span class="nc" id="L260">			Thread.sleep(time);</span>
<span class="nc" id="L261">		} catch (InterruptedException e1) {</span>
<span class="nc" id="L262">			match.getLogger().log(e1,&quot;The thread has been interrupted.&quot;);</span>
<span class="nc" id="L263">			Thread.currentThread().interrupt();</span>
		}
<span class="nc" id="L265">		List&lt;HSBColor&gt; colors = HSBColor.getNDifferent(this.users.size());</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">		for (int i = 0; i &lt; this.users.size(); i++) {</span>
<span class="nc" id="L267">			PlayerCD4 temp = new PlayerCD4(users.get(i).getUserID(), users.get(i).getName(), colors.get(i), this.match,</span>
<span class="nc" id="L268">					new PocketCD4(new Coin(0), new Assistant(0), new NobilityRank(0), new VictoryPoint(0)));</span>
<span class="nc" id="L269">			temp.setStatus(true);</span>
<span class="nc" id="L270">			this.match.addPlayer(temp);</span>
		}
<span class="nc" id="L272">		match.setOrder(match.getPlayers());</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">		for (int i = 0; i &lt; this.users.size(); i++) {</span>
<span class="nc" id="L274">			match.getPlayers().get(i).getPocket().addPocketable(new Coin(10 + i));</span>
<span class="nc" id="L275">			match.getPlayers().get(i).getPocket().addPocketable(new Assistant(1 + i));</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">			for (int j = 0; j &lt; 6; j++) {</span>
				try {
<span class="nc" id="L278">					match.getPlayers().get(i).getPoliticsCards().add(match.getBoard().getPoliticsDeck().drawCard());</span>
<span class="nc" id="L279">				} catch (NoCardsException e) {</span>
<span class="nc" id="L280">					match.getLogger().log(e, &quot;Not enough cards for all players!&quot;);</span>
				}
			}
		}

		/*
		 * This is the routine for the short games. It is runned only if the
		 * number of player in the game is limited to 2 people to fill the map
		 * with some emporiums to make things more interesting
		 */
<span class="nc bnc" id="L290" title="All 2 branches missed.">		if (this.users.size() &lt;= 2) {</span>
<span class="nc" id="L291">			Random random = new Random();</span>
<span class="nc" id="L292">			int bound = Math.abs(random.nextInt(6))+3;</span>
<span class="nc" id="L293">			List&lt;HSBColor&gt; col = HSBColor.getNDifferent(4);</span>
<span class="nc" id="L294">			List&lt;PlayerCD4&gt; players = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L295">			PlayerCD4 p1 = new PlayerCD4(0, &quot;NullPlayer&quot;, col.get(2), this.match,</span>
<span class="nc" id="L296">					new PocketCD4(new Coin(0), new Assistant(0), new NobilityRank(0), new VictoryPoint(0)));</span>
<span class="nc" id="L297">			PlayerCD4 p2 = new PlayerCD4(0, &quot;NullPlayer&quot;, col.get(3), this.match,</span>
<span class="nc" id="L298">					new PocketCD4(new Coin(0), new Assistant(0), new NobilityRank(0), new VictoryPoint(0)));</span>
<span class="nc" id="L299">			players.add(p1);</span>
<span class="nc" id="L300">			players.add(p2);</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">			for (int j = 0; j &lt; bound; j++) {</span>
<span class="nc" id="L302">				int ind = Math.abs(random.nextInt());</span>
<span class="nc" id="L303">				City c = this.match.getBoard().getCities().get(ind % match.getBoard().getCities().size());</span>
<span class="nc" id="L304">				System.out.println(&quot;Places an emporium of the color &quot; + players.get(ind % 2).getColor().printTag()</span>
<span class="nc" id="L305">						+ &quot; in &quot; + c.getName());</span>
<span class="nc" id="L306">				c.addEmporium(new Emporium(players.get(ind % 2), c));</span>
			}
		}
<span class="nc" id="L309">		match.beginTurn();</span>
<span class="nc" id="L310">	}</span>

	/**
	 * @return the match
	 */
	public MatchCD4 getMatch() {
<span class="nc" id="L316">		return match;</span>
	}

	/**
	 * @param match
	 *            the match to set
	 */
	public void setMatch(MatchCD4 match) {
<span class="nc" id="L324">		this.match = match;</span>
<span class="nc" id="L325">	}</span>

	/**
	 * @return the viewProxy
	 */
	public ViewProxy getViewProxy() {
<span class="nc" id="L331">		return viewProxy;</span>
	}

	/**
	 * @return the actionController
	 */
	public ActionController getActionController() {
<span class="nc" id="L338">		return actionController;</span>
	}

	/**
	 * This methof is meant to check if the game is full
	 * 
	 * @return true if it is full false otherwise
	 */
	public boolean isFull() {
<span class="nc bnc" id="L347" title="All 2 branches missed.">		return this.users.size() &gt;= maxLenght;</span>
	}

	/**
	 * this method is meant to check if the game can start
	 * 
	 * @return True if can start false if not
	 */
	public boolean canStart() {
<span class="nc bnc" id="L356" title="All 2 branches missed.">		return this.users.stream().filter(u -&gt; u.isActive()).count() &gt;= minLenght;</span>
	}

	@Override
	public synchronized void addUser(User e) {
<span class="nc bnc" id="L361" title="All 2 branches missed.">		if (e == null)</span>
<span class="nc" id="L362">			throw new NullPointerException();</span>
<span class="nc" id="L363">		this.users.add(e);</span>
<span class="nc" id="L364">		notifyAll();</span>
<span class="nc" id="L365">	}</span>

	@Override
	public boolean isRunning() {
<span class="nc bnc" id="L369" title="All 4 branches missed.">		if(!match.isRunning() &amp;&amp; this.endingTimeStamp == null)</span>
<span class="nc" id="L370">			this.endingTimeStamp = new Date(System.currentTimeMillis()+300000);</span>
<span class="nc bnc" id="L371" title="All 4 branches missed.">		return (match.isRunning() || this.endingTimeStamp.after(new Date()));</span>
	}

	@Override
	public Serializable getStatus(int id) throws ElementNotFoundException {
<span class="nc" id="L376">		return match.getStatus(id);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>