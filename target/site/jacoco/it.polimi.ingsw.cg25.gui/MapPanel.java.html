<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MapPanel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cg25</a> &gt; <a href="index.source.html" class="el_package">it.polimi.ingsw.cg25.gui</a> &gt; <span class="el_source">MapPanel.java</span></div><h1>MapPanel.java</h1><pre class="source lang-java linenums">package it.polimi.ingsw.cg25.gui;

import java.awt.Font;
import java.awt.Image;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import javax.imageio.ImageIO;
import javax.swing.ImageIcon;
import javax.swing.JLabel;
import javax.swing.JLayeredPane;

import it.polimi.ingsw.cg25.model.dto.DTOEmporium;
import it.polimi.ingsw.cg25.model.dto.DTORegion;
import it.polimi.ingsw.cg25.model.dto.GameStatus;

/**
 * 
 * @author Giovanni
 *
 */
@SuppressWarnings(&quot;serial&quot;)
public class MapPanel extends JLayeredPane implements Updatable&lt;GameStatus&gt; {
	
	/**
	 * Background layer level
	 */
	private static final int BACK_LABEL_LAYER = 0;
	/**
	 * Layer level used for regions' labels and permit cards
	 */
	private static final int MAP_LABEL_LAYER = 1;
	/**
	 * Layer level used for the map image
	 */
	private static final int MAP_LAYER = 2;
	/**
	 * Layer level used by the cities placed on the map image
	 */
	private static final int COMP_LAYER = 3;
	/**
	 * Layer lavel for emporiums and colors' labels
	 */
	private static final int COL_EMP_LAYER = 4;
	/**
	 * Region panel width
	 */
	private static final int REG_CONST_X = 244;
	/**
	 * Region panel height
	 */
	private static final int REG_CONST_Y = 40;
	/**
	 * Map image
	 */
	private Image map;
	/**
	 * Crown image
	 */
	private Image crown;
	/**
	 * Label for the crown
	 */
	private JLabel crw;
	/**
	 * The font to be used in any writing
	 */
	private final Font font;
	/**
	 * Regions' panels
	 */
	private final List&lt;RegionTextPanel&gt; regionPanels;
	/**
	 * A List of city colors' labels
	 */
	private final List&lt;CityColorLabel&gt; cityColLabels;
	/**
	 * A List of permit cards' panes
	 */
	private final List&lt;PermitPane&gt; permitPanes;
	/**
	 * Initial update ? first update : generic update
	 */
<span class="nc" id="L86">	private boolean initSet = true;</span>
	
	/**
	 * Points where cities must be placed. Follow the order in &quot;cities&quot;
	 * configuration file
	 */
<span class="nc" id="L92">	private static final CityPoint[] points = {</span>
			new CityPoint(87, 48), new CityPoint(276, 45), new CityPoint(330, 242), 
			new CityPoint(500, 45), new CityPoint(610, 162), new CityPoint(185, 85), 
			new CityPoint(112, 238), new CityPoint(416, 178), new CityPoint(500, 130), 
			new CityPoint(113, 150), new CityPoint(385, 48), new CityPoint(600, 70),
			new CityPoint(215, 199), new CityPoint(490, 228), new CityPoint(290, 139)};
	
	/**
	 * MapPanel class constructor
	 * @param x the horizontal position of the panel
	 * @param y the vertical position of the panel
	 * @param w the width of the panel
	 * @param h the height of the panel
	 * @param font the font to use for any writing
	 */
<span class="nc" id="L107">	public MapPanel(int x, int y, int w, int h, Font font) {</span>
<span class="nc" id="L108">		this.setLayout(null);</span>
<span class="nc" id="L109">		this.setBounds(x, y, w, h);</span>
<span class="nc" id="L110">		this.font = font;</span>
		
<span class="nc" id="L112">		this.regionPanels = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L113">		this.cityColLabels = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L114">		this.permitPanes = new ArrayList&lt;&gt;();</span>
		
		//Background label
<span class="nc" id="L117">		JLabel backLabel = new JLabel();</span>
<span class="nc" id="L118">		backLabel.setBounds(255, 225, 225, 30);</span>
<span class="nc" id="L119">		backLabel.setFont(new Font(font.getName(), Font.BOLD, 30));</span>
<span class="nc" id="L120">		backLabel.setText(&quot;The Council of Four&quot;);</span>
<span class="nc" id="L121">		this.add(backLabel);</span>
<span class="nc" id="L122">		this.setLayer(backLabel, BACK_LABEL_LAYER);</span>
		
<span class="nc" id="L124">		permitPanes.add(new PermitPane(53, 410, font));</span>
<span class="nc" id="L125">		permitPanes.add(new PermitPane(123, 410, font));</span>
<span class="nc" id="L126">		permitPanes.add(new PermitPane(297, 410, font));</span>
<span class="nc" id="L127">		permitPanes.add(new PermitPane(367, 410, font));</span>
<span class="nc" id="L128">		permitPanes.add(new PermitPane(541, 410, font));</span>
<span class="nc" id="L129">		permitPanes.add(new PermitPane(611, 410, font));</span>
		
<span class="nc bnc" id="L131" title="All 2 branches missed.">		for(PermitPane pp : permitPanes) {</span>
<span class="nc" id="L132">			this.add(pp);</span>
<span class="nc" id="L133">			this.setLayer(pp, MAP_LABEL_LAYER);</span>
<span class="nc" id="L134">		}</span>
		
		try {
<span class="nc" id="L137">			crown = ImageIO.read(new File(&quot;src/main/resources/crown.png&quot;));</span>
<span class="nc" id="L138">		} catch (IOException e) {</span>
<span class="nc" id="L139">			e.printStackTrace();</span>
<span class="nc" id="L140">		}</span>
<span class="nc" id="L141">		crw = new JLabel(new ImageIcon(crown.getScaledInstance(25, 18, Image.SCALE_SMOOTH)));</span>
<span class="nc" id="L142">		crw.setSize(crw.getIcon().getIconWidth(), crw.getIcon().getIconHeight());</span>
<span class="nc" id="L143">	}</span>
	
	/**
	 * This method loads the correct map and cities
	 * @param gs a GameStatus object to parse
	 * @throws IOException if the map file is missing
	 */
	private void mapLoader(GameStatus gs) throws IOException {
		//If Arkon-Burgen is not present
<span class="nc bnc" id="L152" title="All 2 branches missed.">		if(!gs.getBoard().getRoadNetwork().containsEdge(gs.getBoard().getCities().get(0),</span>
<span class="nc" id="L153">				gs.getBoard().getCities().get(9))) {</span>
<span class="nc" id="L154">			map = ImageIO.read(new File(&quot;src/main/resources/map1s.png&quot;));</span>
		}
		else {
			//If Indur-Juvelar is present
<span class="nc bnc" id="L158" title="All 2 branches missed.">			if(gs.getBoard().getRoadNetwork().containsEdge(gs.getBoard().getCities().get(7),</span>
<span class="nc" id="L159">					gs.getBoard().getCities().get(10))) {</span>
<span class="nc" id="L160">				map = ImageIO.read(new File(&quot;src/main/resources/map2s.png&quot;));</span>
			}
<span class="nc" id="L162">			else map = ImageIO.read(new File(&quot;src/main/resources/map3s.png&quot;));</span>
		}
		
<span class="nc" id="L165">		Image scaledMap = map.getScaledInstance(this.getWidth(), 360, Image.SCALE_SMOOTH);</span>
<span class="nc" id="L166">		JLabel map = new JLabel(new ImageIcon(scaledMap));</span>
<span class="nc" id="L167">		map.setBounds(0, REG_CONST_Y, map.getIcon().getIconWidth(), map.getIcon().getIconHeight());</span>
<span class="nc" id="L168">		this.add(map);</span>
<span class="nc" id="L169">		this.setLayer(map, MAP_LAYER);</span>
		
<span class="nc bnc" id="L171" title="All 2 branches missed.">		for(int i = 0; i &lt; gs.getBoard().getCities().size(); i++) {</span>
			//Add city
<span class="nc" id="L173">			CityLabel city = new CityLabel(points[i].getX(), points[i].getY(), </span>
<span class="nc" id="L174">					gs.getBoard().getCities().get(i), this.font);</span>
<span class="nc" id="L175">			this.add(city);</span>
<span class="nc" id="L176">			this.setLayer(city, COMP_LAYER);</span>
			//Add city color
<span class="nc" id="L178">			CityColorLabel cc = new CityColorLabel(points[i].getX() + 75, points[i].getY() + 5,font);</span>
<span class="nc" id="L179">			this.cityColLabels.add(cc);</span>
<span class="nc" id="L180">			this.add(cc);</span>
<span class="nc" id="L181">			this.setLayer(cc, COL_EMP_LAYER);</span>
		}
<span class="nc" id="L183">	}</span>

	@Override
	public void update(GameStatus object) {
<span class="nc bnc" id="L187" title="All 2 branches missed.">		if(initSet) {</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">			for(int i = 0; i &lt; object.getBoard().getRegions().size(); i++) {</span>
<span class="nc" id="L189">				regionPanels.add(new RegionTextPanel(0 + i*REG_CONST_X, 0, REG_CONST_X, REG_CONST_Y, </span>
<span class="nc" id="L190">						object.getBoard().getRegions().get(i), font));</span>
<span class="nc" id="L191">				this.add(regionPanels.get(i));</span>
<span class="nc" id="L192">				this.setLayer(regionPanels.get(i), MAP_LABEL_LAYER);</span>
			}
			try {
<span class="nc" id="L195">				mapLoader(object);</span>
<span class="nc" id="L196">			} catch (IOException e) {</span>
<span class="nc" id="L197">				System.out.println(&quot;Failed while loading the map!&quot;);</span>
<span class="nc" id="L198">				e.printStackTrace();</span>
<span class="nc" id="L199">			}</span>
<span class="nc" id="L200">			this.add(crw);</span>
<span class="nc" id="L201">			this.setLayer(crw, COL_EMP_LAYER + 1);</span>
			
<span class="nc" id="L203">			initSet = false;</span>
		}
		//Do always - update color and emporiums - update permit cards
<span class="nc bnc" id="L206" title="All 2 branches missed.">		for(int i = 0; i &lt; cityColLabels.size(); i++) {</span>
<span class="nc" id="L207">			cityColLabels.get(i).update(object.getBoard().getCities().get(i).getColor());</span>
<span class="nc" id="L208">			int index = 0;</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">			for(DTOEmporium emp : object.getBoard().getCities().get(i).getEmporiums()) {</span>
<span class="nc" id="L210">				CityEmporiums em = new CityEmporiums(points[i].getX() - 8, points[i].getY() + index + 12, emp);</span>
<span class="nc" id="L211">				index += 8;</span>
<span class="nc" id="L212">				this.add(em);</span>
<span class="nc" id="L213">				this.setLayer(em, COL_EMP_LAYER);</span>
<span class="nc" id="L214">			}</span>
		}
		
		//Handles the case when faced up permits are less than 2 per region
<span class="nc" id="L218">		int index = 0;</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">		for(DTORegion r : object.getBoard().getRegions()) {</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">			if(r.getFaceUpPermits().size() == 0) {</span>
<span class="nc" id="L221">				permitPanes.get(index).setEmpty(true);</span>
<span class="nc" id="L222">				permitPanes.get(index + 1).setEmpty(true);</span>
<span class="nc" id="L223">				index += 2;</span>
			}
<span class="nc bnc" id="L225" title="All 2 branches missed.">			else if(r.getFaceUpPermits().size() == 1) {</span>
<span class="nc" id="L226">				permitPanes.get(index).update(r.getFaceUpPermits().get(0));</span>
<span class="nc" id="L227">				permitPanes.get(index + 1).setEmpty(true);</span>
<span class="nc" id="L228">				index += 2;</span>
			}
<span class="nc bnc" id="L230" title="All 2 branches missed.">			else if(r.getFaceUpPermits().size() == 2) {</span>
<span class="nc" id="L231">				permitPanes.get(index).update(r.getFaceUpPermits().get(0));</span>
<span class="nc" id="L232">				permitPanes.get(index + 1).update(r.getFaceUpPermits().get(1));</span>
<span class="nc" id="L233">				index += 2;</span>
			}
<span class="nc" id="L235">			else throw new IllegalArgumentException(&quot;An error occured while setting up permit cards!&quot;);</span>
<span class="nc" id="L236">		}</span>
		
		//Set the crown position
<span class="nc" id="L239">		int kingIndex = object.getBoard().getCities().indexOf(object.getBoard().getKingCity());</span>
<span class="nc" id="L240">		crw.setLocation(points[kingIndex].getX() + 25, points[kingIndex].getY() + 70);</span>
		
		//Update regions' bonus
<span class="nc bnc" id="L243" title="All 2 branches missed.">		for(int i = 0; i &lt; regionPanels.size(); i++)</span>
<span class="nc" id="L244">			regionPanels.get(i).update(object.getBoard().getRegions().get(i));</span>
		
<span class="nc" id="L246">		this.repaint();</span>
<span class="nc" id="L247">	}</span>
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>